<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Niji Trip 2026 Â· æš–è‰²ä¸»é¡Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffd48d" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg-cream: #fff7ec;
      --blue-soft: #a9e2ff;
      --peach-soft: #ffb4a2;
      --yellow-soft: #ffe08a;
      --brown-main: #5a3b32;
      --brown-soft: #7a5446;
      --border-soft: #ead8c0;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Noto Sans TC", system-ui, sans-serif;
      margin: 0;
      color: var(--brown-main);
      background:
        radial-gradient(circle at 0% 0%, var(--blue-soft) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, var(--peach-soft) 0, transparent 55%),
        radial-gradient(circle at 50% 110%, var(--yellow-soft) 0, transparent 60%),
        var(--bg-cream);
      min-height: 100vh;
    }
    header {
      background: rgba(255, 247, 236, 0.9);
      backdrop-filter: blur(8px);
      color: var(--brown-main);
      padding: 14px 16px 6px;
      box-shadow: 0 2px 8px rgba(190, 150, 110, 0.35);
      position: relative;
      z-index: 5;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.06em;
    }
    header p {
      margin: 4px 0 0;
      font-size: 12px;
      opacity: 0.9;
    }
    header .hint {
      margin: 4px 0 2px;
      font-size: 11px;
      opacity: 0.85;
    }
    .toolbar {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }
    .toolbar button {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: #ffe0a8;
      color: var(--brown-main);
      box-shadow: 0 1px 3px rgba(190, 150, 110, 0.5);
    }

    .day-nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 247, 236, 0.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(234, 216, 192, 0.9);
    }
    .day-nav-row {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      padding: 6px 8px;
      scrollbar-width: thin;
    }
    .day-nav-row::-webkit-scrollbar { height: 4px; }
    .day-nav-row::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, var(--blue-soft), var(--peach-soft));
      border-radius: 999px;
    }
    .day-chip {
      flex: 0 0 auto;
      text-decoration: none;
      color: var(--brown-main);
      background: rgba(255, 253, 248, 0.95);
      border-radius: 999px;
      border: 1px solid rgba(234, 216, 192, 1);
      padding: 4px 10px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 72px;
      box-shadow: 0 1px 3px rgba(200, 170, 130, 0.35);
      cursor: pointer;
    }
    .day-chip-main {
      font-weight: 600;
      font-size: 12px;
    }
    .day-chip-sub {
      font-size: 10px;
      opacity: 0.9;
    }
    .day-chip[contenteditable="true"] { cursor: text; }
    .day-chip.dragging {
      opacity: 0.8;
      box-shadow: 0 4px 10px rgba(150, 110, 80, 0.65);
    }

    .container {
      padding: 12px 14px 56px;
      max-width: 860px;
      margin: 0 auto;
    }
    .day-title {
      background: rgba(255, 253, 248, 0.96);
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      margin-top: 14px;
      box-shadow: 0 1px 4px rgba(200, 170, 130, 0.45);
      border: 1px solid var(--border-soft);
      font-size: 14px;
    }
    .spot-card {
      background: #fffdfa;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 10px 14px;
      margin-top: 8px;
      box-shadow: 0 1px 4px rgba(200, 170, 130, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }
    .spot-card.dragging {
      opacity: 0.8;
      box-shadow: 0 4px 10px rgba(150, 110, 80, 0.65);
      transform: scale(1.01);
    }
    .lodging-card {
      background: #fff4de;
      border-style: dashed;
    }
    .spot-text { font-size: 13px; }
    .spot-text .name-zh {
      font-weight: 600;
      font-size: 14px;
      color: var(--brown-main);
    }
    .spot-text .name-ja {
      color: #756455;
      font-size: 13px;
    }
    .spot-meta {
      font-size: 11px;
      color: #8f7b6a;
      margin-top: 3px;
    }

    .btn-row {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      background: #ffd48d;
      color: var(--brown-main);
      box-shadow: 0 1px 4px rgba(190, 150, 110, 0.5);
    }
    .btn.secondary {
      background: #fff7ec;
      border: 1px solid var(--border-soft);
      box-shadow: none;
    }
    .drag-handle {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #ffe8bf;
      border: 1px dashed var(--border-soft);
      cursor: grab;
      user-select: none;
    }

    .expense-card {
      background: #fff7ec;
      border: 1px dashed var(--border-soft);
      border-radius: 12px;
      padding: 8px 10px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--brown-soft);
    }
    .expense-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--brown-main);
    }

    .quick-add {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255, 253, 248, 0.9);
      border: 1px dashed var(--border-soft);
      font-size: 11px;
      color: var(--brown-soft);
    }
    .quick-add-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--brown-main);
    }
    .quick-add-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .quick-add-row input {
      flex: 1 1 130px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      font-family: inherit;
      color: var(--brown-main);
      background: #fffdf7;
    }
    .quick-add-row button {
      padding: 5px 10px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      background: #ffd48d;
      color: var(--brown-main);
      box-shadow: 0 1px 3px rgba(190, 150, 110, 0.5);
      cursor: pointer;
      flex: 0 0 auto;
    }

    .custom-section {
      border-top: 1px dashed var(--border-soft);
      margin-top: 20px;
      padding-top: 10px;
    }
    .custom-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--brown-main);
    }
    .custom-placeholder {
      border: 1px dashed var(--border-soft);
      border-radius: 10px;
      padding: 10px;
      background: rgba(255, 253, 248, 0.95);
      font-size: 12px;
      color: var(--brown-soft);
      margin-top: 6px;
    }

    .editable-block { outline: none; }
    .editable-block:focus-within,
    .editable-block:focus {
      box-shadow: 0 0 0 2px rgba(255, 212, 141, 0.9);
      border-color: #ffd48d;
    }

    .save-indicator {
      position: fixed;
      right: 16px;
      bottom: 76px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(90, 59, 50, 0.95);
      color: #fffdf7;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.25s ease;
      box-shadow: 0 2px 6px rgba(120, 90, 70, 0.7);
      z-index: 40;
    }
    .save-indicator.visible { opacity: 1; }

    .undo-btn {
      position: fixed;
      right: 16px;
      bottom: 20px;
      z-index: 50;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #ffd48d;
      color: var(--brown-main);
      box-shadow: 0 3px 8px rgba(150, 110, 80, 0.65);
      cursor: pointer;
    }
    .undo-btn[disabled] {
      opacity: 0.5;
      box-shadow: none;
      cursor: default;
    }

    .image-list {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .spot-photo {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 3px rgba(190, 150, 110, 0.4);
      cursor: pointer;
    }
    .spot-photo:hover { opacity: 0.85; }

    .spot-note {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #fff7ec;
      border: 1px dashed var(--border-soft);
      font-size: 11px;
      color: var(--brown-soft);
    }
    .spot-note-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
      color: var(--brown-main);
    }
    .spot-note-body {
      font-size: 11px;
      white-space: pre-wrap;
    }
    .spot-note-title .note-photo-btn {
      padding: 3px 8px;
      font-size: 10px;
    }
  </style>
</head>
<body>
<header>
  <h1 contenteditable="true" class="editable-block">Niji Trip 2026 ğŸŒˆ</h1>
  <p contenteditable="true" class="editable-block">
    æ±äº¬è¡Œç¨‹ Â· æš–è‰²ä¸»é¡Œ Â· æ‹–æ‹‰æ’åºï¼‹ä½å®¿æ¬„ä½ï¼‹æ¯æ—¥èŠ±è²»ï¼‹å›ä¸Šä¸€æ­¥
  </p>
  <div class="hint">
    âœï¸ è¡Œç¨‹å¡å¯ä»¥ç›´æ¥æ”¹æ–‡å­—ã€æ‹–æ‹‰æ’åºï¼›æ”¹éŒ¯å¯ä»¥ç”¨å³ä¸‹è§’ã€Œå›ä¸Šä¸€æ­¥ã€ã€‚
  </div>

  <div class="toolbar">
    <button type="button" id="btnExport">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
    <button type="button" id="btnImport">åŒ¯å…¥å‚™ä»½</button>
    <button type="button" id="btnAddDay">ï¼‹ æ–°å¢ä¸€å¤©</button>
    <button type="button" id="btnRemoveDay">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
  </div>
</header>

<input type="file" id="backupImport" accept="application/json" style="display:none" />
<input type="file" id="photoInput" accept="image/*" style="display:none" />

<div class="day-nav">
  <div class="day-nav-row">
    <a class="day-chip" href="#day-1" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 1</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/8</span>
    </a>
    <a class="day-chip" href="#day-2" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 2</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/9</span>
    </a>
    <a class="day-chip" href="#day-3" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 3</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/10</span>
    </a>
    <a class="day-chip" href="#day-4" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 4</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/11</span>
    </a>
    <a class="day-chip" href="#day-5" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 5</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/12</span>
    </a>
    <a class="day-chip" href="#day-6" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 6</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/13</span>
    </a>
    <a class="day-chip" href="#day-7" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 7</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/14</span>
    </a>
    <a class="day-chip" href="#day-8" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 8</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/15</span>
    </a>
    <a class="day-chip" href="#day-9" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 9</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/16</span>
    </a>
    <a class="day-chip" href="#day-10" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 10</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/17</span>
    </a>
    <a class="day-chip" href="#day-11" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 11</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/18</span>
    </a>
    <a class="day-chip" href="#day-12" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 12</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/19</span>
    </a>
    <a class="day-chip" href="#day-13" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 13</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/20</span>
    </a>
    <a class="day-chip" href="#day-14" draggable="true">
      <span class="day-chip-main" contenteditable="true" spellcheck="false">Day 14</span>
      <span class="day-chip-sub" contenteditable="true" spellcheck="false">5/21</span>
    </a>
  </div>
</div>

<div class="container" id="content">

  <!-- Day 1ï¼šç¤ºç¯„æœ‰å…©å¼µæ™¯é»å¡ï¼‹å‚™è¨»ï¼‹å¿«é€Ÿæ–°å¢ -->
  <section id="day-1" data-date="5/8">
    <div class="day-title editable-block" contenteditable="true">Day 1 ï¼ˆ5/8ï¼‰</div>

    <div class="spot-card editable-block" contenteditable="false">
      <div class="spot-text">
        <div class="name-zh editable-block" contenteditable="true">æˆç”°æ©Ÿå ´</div>
        <div class="name-ja editable-block" contenteditable="true">æˆç”°ç©ºæ¸¯</div>
        <div class="spot-meta editable-block" contenteditable="true">æˆç”°ãƒ»ä¸Šé‡ Â· æŠµé”æ—¥æœ¬</div>
      </div>
      <div class="btn-row" contenteditable="false">
        <button class="btn btn-dir" data-dest-jp="æˆç”°ç©ºæ¸¯" type="button">å¾é£¯åº—å°èˆª</button>
        <button class="btn secondary btn-search" data-dest-jp="æˆç”°ç©ºæ¸¯" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn secondary btn-photo" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        <span class="drag-handle">â ¿ æ‹–æ‹‰èª¿æ•´é †åº</span>
      </div>
      <div class="image-list"></div>
      <div class="spot-note">
        <div class="spot-note-title">
          å‚™è¨»
          <button type="button" class="btn secondary note-photo-btn" contenteditable="false">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="spot-note-body editable-block" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦
        </div>
        <div class="image-list"></div>
      </div>
    </div>

    <div class="spot-card lodging-card editable-block" contenteditable="false">
      <div class="spot-text">
        <div class="name-zh editable-block" contenteditable="true">ä½å®¿ï¼šVESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—</div>
        <div class="name-ja editable-block" contenteditable="true">ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰</div>
        <div class="spot-meta editable-block" contenteditable="true">ä¸Šé‡ãƒ»å…¥è°· Â· ä½å®¿åœ°é»</div>
      </div>
      <div class="btn-row" contenteditable="false">
        <button class="btn btn-dir" data-dest-jp="ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰" type="button">å¾é£¯åº—å°èˆª</button>
        <button class="btn secondary btn-search" data-dest-jp="ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn secondary btn-photo" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        <span class="drag-handle">â ¿ æ‹–æ‹‰èª¿æ•´é †åº</span>
      </div>
      <div class="image-list"></div>
      <div class="spot-note">
        <div class="spot-note-title">
          å‚™è¨»
          <button type="button" class="btn secondary note-photo-btn" contenteditable="false">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="spot-note-body editable-block" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦
        </div>
        <div class="image-list"></div>
      </div>
    </div>

    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦</div>
    </div>

    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <!-- Day 2 ~ Day 14ï¼šå…ˆæ”¾ç©ºç™½æ¨¡æ¿ï¼Œè®“ä½ åœ¨é é¢ä¸Šè£œå¡ç‰‡æˆ–è²¼å›èˆŠæª”å…§å®¹ -->

  <section id="day-2" data-date="5/9">
    <div class="day-title editable-block" contenteditable="true">Day 2 ï¼ˆ5/9ï¼‰</div>

    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>

    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-3" data-date="5/10">
    <div class="day-title editable-block" contenteditable="true">Day 3 ï¼ˆ5/10ï¼‰</div>

    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>

    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-4" data-date="5/11">
    <div class="day-title editable-block" contenteditable="true">Day 4 ï¼ˆ5/11ï¼‰</div>

    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>

    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-5" data-date="5/12">
    <div class="day-title editable-block" contenteditable="true">Day 5 ï¼ˆ5/12ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-6" data-date="5/13">
    <div class="day-title editable-block" contenteditable="true">Day 6 ï¼ˆ5/13ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-7" data-date="5/14">
    <div class="day-title editable-block" contenteditable="true">Day 7 ï¼ˆ5/14ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-8" data-date="5/15">
    <div class="day-title editable-block" contenteditable="true">Day 8 ï¼ˆ5/15ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-9" data-date="5/16">
    <div class="day-title editable-block" contenteditable="true">Day 9 ï¼ˆ5/16ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-10" data-date="5/17">
    <div class="day-title editable-block" contenteditable="true">Day 10 ï¼ˆ5/17ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-11" data-date="5/18">
    <div class="day-title editable-block" contenteditable="true">Day 11 ï¼ˆ5/18ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-12" data-date="5/19">
    <div class="day-title editable-block" contenteditable="true">Day 12 ï¼ˆ5/19ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-13" data-date="5/20">
    <div class="day-title editable-block" contenteditable="true">Day 13 ï¼ˆ5/20ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <section id="day-14" data-date="5/21">
    <div class="day-title editable-block" contenteditable="true">Day 14 ï¼ˆ5/21ï¼‰</div>
    <div class="expense-card editable-block" contenteditable="true">
      <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
      <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
    </div>
    <div class="quick-add">
      <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
      <div class="quick-add-row">
        <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰" />
        <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€" />
        <button type="button" class="qa-btn">æ–°å¢</button>
      </div>
    </div>
  </section>

  <div class="custom-section editable-block" contenteditable="true">
    <div class="custom-title">âœï¸ å…¶ä»–è£œå……è¨˜éŒ„ï¼ˆé ç•™ç©ºé–“ï¼‰</div>
    <div class="custom-placeholder">
      å¯åœ¨é€™è£¡è¨˜éŒ„æ•´è¶Ÿæ—…ç¨‹ç¸½èŠ±è²»ã€å›åœ‹å¾Œå¿ƒå¾—ã€æƒ³å†å»çš„åº—å®¶æ¸…å–®ç­‰ç­‰ã€‚
    </div>
  </div>
</div>

<button class="undo-btn" id="undoBtn" disabled>ğŸ•˜ å›ä¸Šä¸€æ­¥</button>
<div class="save-indicator" id="saveIndicator">å·²è‡ªå‹•å„²å­˜</div>

<script>
(function () {
  const STORAGE_KEY = "nijiTrip2026_v11";
  const UNDO_LIMIT = 20;

  let undoStack = [];
  let isRestoring = false;
  let currentPhotoTarget = null;

  function ensureFloatingUI() {
    let saveIndicator = document.getElementById("saveIndicator");
    if (!saveIndicator) {
      saveIndicator = document.createElement("div");
      saveIndicator.id = "saveIndicator";
      saveIndicator.className = "save-indicator";
      saveIndicator.textContent = "å·²å„²å­˜ âœ”";
      document.body.appendChild(saveIndicator);
    }
    let undoBtn = document.getElementById("undoBtn");
    if (!undoBtn) {
      undoBtn = document.createElement("button");
      undoBtn.id = "undoBtn";
      undoBtn.className = "undo-btn";
      undoBtn.textContent = "â†© å›ä¸Šä¸€æ­¥";
      document.body.appendChild(undoBtn);
      undoBtn.addEventListener("click", handleUndo);
    }
  }

  function showSaved() {
    const el = document.getElementById("saveIndicator");
    if (!el) return;
    el.classList.add("visible");
    setTimeout(() => el.classList.remove("visible"), 800);
  }

  function updateUndoBtn() {
    const undoBtn = document.getElementById("undoBtn");
    if (!undoBtn) return;
    undoBtn.disabled = undoStack.length <= 1;
  }

  function getContentHTML() {
    const content = document.getElementById("content");
    return content ? content.innerHTML : "";
  }

  function setContentHTML(html) {
    const content = document.getElementById("content");
    if (content) content.innerHTML = html;
  }

  function saveState(pushToUndo = true) {
    if (isRestoring) return;
    const html = getContentHTML();
    if (!html) return;

    if (pushToUndo) {
      undoStack.push(html);
      if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    }
    localStorage.setItem(STORAGE_KEY, html);
    showSaved();
    updateUndoBtn();
  }

  function handleUndo() {
    if (undoStack.length <= 1) return;
    undoStack.pop();
    const prev = undoStack[undoStack.length - 1];
    if (!prev) return;
    isRestoring = true;
    setContentHTML(prev);
    enhanceAllCards();
    attachCardEvents();
    attachDragAndDrop();
    attachPhotoFeature();
    attachMapButtons();
    attachDayDrag();
    isRestoring = false;
    updateUndoBtn();
  }

  function restoreFromLocal() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) setContentHTML(saved);
  }

  function enhanceAllCards() {
    const cards = document.querySelectorAll(".spot-card");
    cards.forEach(card => {
      let row = card.querySelector(".btn-row");
      if (!row) return;

      if (!row.querySelector(".btn-photo")) {
        const photoBtn = document.createElement("button");
        photoBtn.type = "button";
        photoBtn.className = "btn secondary btn-photo";
        photoBtn.textContent = "ğŸ“· æ–°å¢åœ–ç‰‡";
        photoBtn.setAttribute("contenteditable", "false");
        const drag = row.querySelector(".drag-handle");
        if (drag) row.insertBefore(photoBtn, drag);
        else row.appendChild(photoBtn);
      }

      if (!card.querySelector(".image-list")) {
        const imgList = document.createElement("div");
        imgList.className = "image-list";
        imgList.setAttribute("contenteditable", "false");
        card.appendChild(imgList);
      }

      let note = card.querySelector(".spot-note");
      if (!note) {
        note = document.createElement("div");
        note.className = "spot-note";
        note.innerHTML = `
          <div class="spot-note-title">
            å‚™è¨»
            <button type="button" class="btn secondary note-photo-btn" contenteditable="false">ğŸ“· æ–°å¢åœ–ç‰‡</button>
          </div>
          <div class="spot-note-body editable-block" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦
          </div>
          <div class="image-list" contenteditable="false"></div>
        `;
        card.appendChild(note);
      } else {
        let title = note.querySelector(".spot-note-title");
        if (!title) {
          title = document.createElement("div");
          title.className = "spot-note-title";
          title.textContent = "å‚™è¨»";
          note.insertBefore(title, note.firstChild);
        }
        if (!note.querySelector(".note-photo-btn")) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn secondary note-photo-btn";
          btn.textContent = "ğŸ“· æ–°å¢åœ–ç‰‡";
          btn.setAttribute("contenteditable", "false");
          title.appendChild(btn);
        }
        let body = note.querySelector(".spot-note-body");
        if (!body) {
          body = document.createElement("div");
          body.className = "spot-note-body editable-block";
          body.setAttribute("contenteditable", "true");
          body.textContent = "å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦";
          note.appendChild(body);
        } else {
          body.classList.add("editable-block");
          body.setAttribute("contenteditable", "true");
        }
        let imgList = note.querySelector(".image-list");
        if (!imgList) {
          imgList = document.createElement("div");
          imgList.className = "image-list";
          imgList.setAttribute("contenteditable", "false");
          note.appendChild(imgList);
        }
      }

      card.setAttribute("draggable", "true");
    });
  }

  function attachDragAndDrop() {
    const content = document.getElementById("content");
    if (!content) return;

    let draggingCard = null;

    content.addEventListener("dragstart", e => {
      const card = e.target.closest(".spot-card");
      if (!card) return;
      draggingCard = card;
      card.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });

    content.addEventListener("dragend", e => {
      const card = e.target.closest(".spot-card");
      if (card) card.classList.remove("dragging");
      if (draggingCard) {
        draggingCard = null;
        saveState();
      }
    });

    content.addEventListener("dragover", e => {
      if (!draggingCard) return;
      e.preventDefault();
      const section = e.target.closest("section[id^='day-']");
      if (!section) return;
      const target = e.target.closest(".spot-card");
      if (!target || target === draggingCard) return;
      const rect = target.getBoundingClientRect();
      const before = e.clientY < rect.top + rect.height / 2;
      if (before) section.insertBefore(draggingCard, target);
      else section.insertBefore(draggingCard, target.nextSibling);
    });
  }

  function addSpot(btn) {
    const wrapper = btn.closest("section");
    if (!wrapper) return;
    const qaRow = btn.closest(".quick-add-row");
    if (!qaRow) return;

    const nameInput = qaRow.querySelector(".qa-name");
    const jpInput = qaRow.querySelector(".qa-jp");
    const nameZh = (nameInput?.value || "").trim() || "æ–°åœ°é»";
    const nameJa = (jpInput?.value || "").trim() || "æ—¥æœ¬èªï¼åœ°å€";

    const card = document.createElement("div");
    card.className = "spot-card editable-block";
    card.setAttribute("contenteditable", "false");
    card.innerHTML = `
      <div class="spot-text">
        <div class="name-zh editable-block" contenteditable="true">${nameZh}</div>
        <div class="name-ja editable-block" contenteditable="true">${nameJa}</div>
        <div class="spot-meta editable-block" contenteditable="true">è‡ªè¨‚è¡Œç¨‹</div>
      </div>
      <div class="btn-row" contenteditable="false">
        <button class="btn btn-dir" data-dest-jp="${nameJa}" type="button">å¾é£¯åº—å°èˆª</button>
        <button class="btn secondary btn-search" data-dest-jp="${nameJa}" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn secondary btn-photo" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        <span class="drag-handle">â ¿ æ‹–æ‹‰èª¿æ•´é †åº</span>
      </div>
      <div class="image-list"></div>
      <div class="spot-note">
        <div class="spot-note-title">
          å‚™è¨»
          <button type="button" class="btn secondary note-photo-btn" contenteditable="false">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="spot-note-body editable-block" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰ç­‰â€¦
        </div>
        <div class="image-list"></div>
      </div>
    `;

    const expense = wrapper.querySelector(".expense-card");
    if (expense) wrapper.insertBefore(card, expense);
    else wrapper.appendChild(card);

    nameInput.value = "";
    jpInput.value = "";

    enhanceAllCards();
    attachCardEvents();
    saveState();
  }
  window.addSpot = addSpot;

  function onEditableInput() {
    if (this._saveTimer) clearTimeout(this._saveTimer);
    this._saveTimer = setTimeout(() => saveState(), 400);
  }

  function attachCardEvents() {
    const content = document.getElementById("content");
    if (!content) return;

    content.querySelectorAll(".editable-block").forEach(el => {
      el.removeEventListener("input", onEditableInput);
      el.addEventListener("input", onEditableInput);
    });

    content.querySelectorAll(".qa-btn").forEach(btn => {
      btn.onclick = function () { addSpot(btn); };
    });
  }

  function attachBackupButtons() {
    const exportBtn = document.getElementById("btnExport");
    const importBtn = document.getElementById("btnImport");
    const fileInput = document.getElementById("backupImport");

    if (exportBtn) {
      exportBtn.addEventListener("click", () => {
        const data = {
          savedAt: new Date().toISOString(),
          html: getContentHTML()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "NijiTrip2026_backup.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    }

    if (importBtn && fileInput) {
      importBtn.addEventListener("click", () => {
        fileInput.value = "";
        fileInput.click();
      });

      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const json = JSON.parse(e.target.result);
            if (json.html) {
              isRestoring = true;
              setContentHTML(json.html);
              enhanceAllCards();
              attachCardEvents();
              attachDragAndDrop();
              attachPhotoFeature();
              attachMapButtons();
              attachDayDrag();
              localStorage.setItem(STORAGE_KEY, json.html);
              undoStack = [json.html];
              isRestoring = false;
              updateUndoBtn();
              showSaved();
            }
          } catch (err) {
            alert("åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
          }
        };
        reader.readAsText(file);
      });
    }
  }

  function attachPhotoFeature() {
    const content = document.getElementById("content");
    const photoInput = document.getElementById("photoInput");
    if (!content || !photoInput) return;

    content.addEventListener("click", e => {
      const cardBtn = e.target.closest(".btn-photo");
      const noteBtn = e.target.closest(".note-photo-btn");
      if (!cardBtn && !noteBtn) return;

      if (cardBtn) {
        const card = cardBtn.closest(".spot-card");
        currentPhotoTarget = card && card.querySelector(".image-list");
      } else {
        const note = noteBtn.closest(".spot-note");
        currentPhotoTarget = note && note.querySelector(".image-list");
      }
      if (!currentPhotoTarget) return;

      photoInput.value = "";
      photoInput.click();
    });

    photoInput.addEventListener("change", () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file || !currentPhotoTarget) return;
      const reader = new FileReader();
      reader.onload = e => {
        const url = e.target.result;
        const list = currentPhotoTarget;
        if (!list) return;
        const img = document.createElement("img");
        img.className = "spot-photo";
        img.src = url;
        img.alt = "è¡Œç¨‹ç…§ç‰‡";
        list.appendChild(img);

        img.addEventListener("click", () => {
          if (confirm("åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ")) {
            img.remove();
            saveState();
          }
        });

        saveState();
      };
      reader.readAsDataURL(file);
    });
  }

  function attachMapButtons() {
    const content = document.getElementById("content");
    if (!content) return;

    content.addEventListener("click", e => {
      const dirBtn = e.target.closest(".btn-dir");
      const searchBtn = e.target.closest(".btn-search");

      let destJp = null;
      const btn = dirBtn || searchBtn;
      if (btn) {
        destJp = btn.getAttribute("data-dest-jp") ||
          (btn.closest(".spot-card")?.querySelector(".name-ja")?.textContent || "").trim();
      }

      if (dirBtn && destJp) {
        const hotel = "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰";
        const url =
          "https://www.google.com/maps/dir/?api=1" +
          "&origin=" + encodeURIComponent(hotel) +
          "&destination=" + encodeURIComponent(destJp);
        window.open(url, "_blank");
      }

      if (searchBtn && destJp) {
        const url =
          "https://www.google.com/maps/search/?api=1&query=" +
          encodeURIComponent(destJp);
        window.open(url, "_blank");
      }
    });
  }

  function addDay() {
    const content = document.getElementById("content");
    const navRow = document.querySelector(".day-nav-row");
    if (!content || !navRow) return;

    const sections = content.querySelectorAll("section[id^='day-']");
    if (sections.length === 0) return;

    const lastSection = sections[sections.length - 1];
    const newIndex = sections.length + 1;
    const newId = "day-" + newIndex;

    const firstChip = navRow.querySelector(".day-chip");
    if (!firstChip) return;

    const newChip = firstChip.cloneNode(true);
    newChip.setAttribute("href", "#" + newId);
    newChip.setAttribute("draggable", "true");

    const mainSpan = newChip.querySelector(".day-chip-main");
    const subSpan = newChip.querySelector(".day-chip-sub");

    if (mainSpan) mainSpan.textContent = "Day " + newIndex;

    const lastDate = lastSection.getAttribute("data-date") || "";
    if (subSpan) subSpan.textContent = lastDate;

    navRow.appendChild(newChip);

    const newSection = lastSection.cloneNode(true);
    newSection.id = newId;
    newSection.setAttribute("data-date", lastDate);

    const titleEl = newSection.querySelector(".day-title");
    if (titleEl) {
      titleEl.textContent = "Day " + newIndex + " ï¼ˆ" + lastDate + "ï¼‰";
    }

    newSection.querySelectorAll("img.spot-photo").forEach(img => img.remove());
    newSection.querySelectorAll(".image-list").forEach(list => list.innerHTML = "");

    content.appendChild(newSection);

    enhanceAllCards();
    attachCardEvents();
    attachDragAndDrop();
    attachPhotoFeature();
    attachMapButtons();
    attachDayDrag();
    saveState();

    newChip.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
    setTimeout(() => {
      newSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 250);
  }

  function removeDay() {
    const content = document.getElementById("content");
    const navRow = document.querySelector(".day-nav-row");
    if (!content || !navRow) return;

    const sections = content.querySelectorAll("section[id^='day-']");
    if (sections.length <= 1) {
      alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©è¡Œç¨‹å–”ï¼");
      return;
    }
    const lastSection = sections[sections.length - 1];
    const lastId = "#" + lastSection.id;

    const chips = navRow.querySelectorAll(".day-chip");
    const lastChip = Array.from(chips).find(ch => ch.getAttribute("href") === lastId) || chips[chips.length - 1];

    if (confirm("ç¢ºå®šè¦åˆªé™¤æœ€å¾Œä¸€å¤©å—ï¼Ÿ")) {
      lastSection.remove();
      if (lastChip) lastChip.remove();
      saveState();
    }
  }

  function attachDayButtons() {
    const addBtn = document.getElementById("btnAddDay");
    const removeBtn = document.getElementById("btnRemoveDay");
    if (addBtn) addBtn.addEventListener("click", addDay);
    if (removeBtn) removeBtn.addEventListener("click", removeDay);
  }

  function attachDayDrag() {
    const navRow = document.querySelector(".day-nav-row");
    const content = document.getElementById("content");
    if (!navRow || !content) return;

    let draggingChip = null;

    navRow.addEventListener("dragstart", e => {
      const chip = e.target.closest(".day-chip");
      if (!chip) return;
      draggingChip = chip;
      chip.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });

    navRow.addEventListener("dragend", () => {
      if (draggingChip) draggingChip.classList.remove("dragging");
      draggingChip = null;
      saveState();
    });

    navRow.addEventListener("dragover", e => {
      if (!draggingChip) return;
      e.preventDefault();
      const target = e.target.closest(".day-chip");
      if (!target || target === draggingChip) return;

      const rect = target.getBoundingClientRect();
      const before = e.clientX < rect.left + rect.width / 2;

      if (before) navRow.insertBefore(draggingChip, target);
      else navRow.insertBefore(draggingChip, target.nextSibling);

      const draggingHref = draggingChip.getAttribute("href");
      const targetHref = target.getAttribute("href");
      const draggingSection = draggingHref && document.querySelector(draggingHref);
      const targetSection = targetHref && document.querySelector(targetHref);
      if (draggingSection && targetSection) {
        const parent = draggingSection.parentElement;
        if (before) parent.insertBefore(draggingSection, targetSection);
        else parent.insertBefore(draggingSection, targetSection.nextSibling);
      }
    });

    navRow.querySelectorAll(".day-chip").forEach(chip => {
      chip.setAttribute("draggable", "true");
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    ensureFloatingUI();
    restoreFromLocal();
    enhanceAllCards();
    attachCardEvents();
    attachDragAndDrop();
    attachBackupButtons();
    attachDayButtons();
    attachPhotoFeature();
    attachMapButtons();
    attachDayDrag();

    undoStack = [getContentHTML()];
    updateUndoBtn();
  });
})();
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(() => {
    console.log("Service Worker è¨»å†Šå¤±æ•—");
  });
}
</script>
</body>
</html>
