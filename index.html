<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Niji Trip 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-main: #fff7e8;
      --bg-card: #ffe7bd;
      --bg-day: #f5fbff;
      --bg-spot: #fffaf3;
      --border-soft: #f0c48d;
      --brown-main: #6d3b1f;
      --brown-soft: #9c6a42;
      --accent: #ffb64b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(#ffe6b8, #ffeecd);
      color: var(--brown-main);
    }
    header {
      padding: 18px 16px 10px;
      background: #ffe6b8;
    }
    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 1px;
    }
    header p {
      margin: 4px 0 0;
      line-height: 1.6;
      font-size: 14px;
    }
    .hint {
      font-size: 13px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .hint span {
      font-size: 18px;
    }
    .top-btn-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--brown-main);
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      white-space: nowrap;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 0 1px rgba(0,0,0,.2);
    }
    .btn-secondary {
      background: #fff9ef;
    }
    .day-nav {
      background: #fff5de;
      padding: 8px 4px 10px;
      overflow-x: auto;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .day-nav-row {
      display: flex;
      gap: 8px;
      padding: 2px 8px;
    }
    .day-chip {
      flex: 0 0 auto;
      min-width: 92px;
      text-align: center;
      background: #fff;
      border-radius: 999px;
      padding: 8px 14px;
      text-decoration: none;
      color: var(--brown-main);
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      border: 1px solid #f7d2a2;
      cursor: grab;
    }
    .day-chip.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }
    .day-chip-main {
      display: block;
      font-weight: 700;
      font-size: 14px;
    }
    .day-chip-sub {
      display: block;
      font-size: 12px;
      margin-top: 2px;
    }
    [contenteditable="true"] {
      outline: none;
    }
    main {
      padding: 10px 10px 90px;
      background: linear-gradient(#e8f5ff, #fff9ee);
    }
    section[id^="day-"] {
      margin: 12px 0;
      background: var(--bg-day);
      border-radius: 18px;
      padding: 14px 12px 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }
    .day-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .expense-card {
      background: #fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      margin-bottom: 10px;
      border: 1px solid #e6f0ff;
    }
    .expense-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .quick-add {
      background: #fffaf3;
      border-radius: 16px;
      border: 1px dashed var(--border-soft);
      padding: 10px 12px 12px;
      margin-bottom: 8px;
    }
    .quick-add-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .quick-add-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .qa-name, .qa-jp {
      flex: 1 1 120px;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid #f1cda0;
      padding: 6px 10px;
      font-size: 13px;
    }
    .qa-btn {
      padding-inline: 14px;
      background: var(--accent);
      color: #5a340c;
      font-weight: 600;
    }

    .spot-card {
      margin-top: 10px;
      background: var(--bg-spot);
      border-radius: 18px;
      padding: 10px 12px 12px;
      border: 1px solid #f5d6ab;
      box-shadow: 0 1px 3px rgba(0,0,0,.12);
    }
    .spot-text .name-zh {
      font-weight: 700;
      font-size: 16px;
    }
    .spot-text .name-ja {
      font-size: 14px;
      margin-top: 2px;
    }
    .spot-meta {
      font-size: 12px;
      margin-top: 4px;
      color: var(--brown-soft);
    }
    .btn-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .btn-row .btn {
      padding: 5px 10px;
      font-size: 12px;
    }
    .btn-drag {
      font-size: 11px;
    }
    .image-list,
    .note-image-list {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .spot-photo {
      width: 72px;
      height: 72px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 3px rgba(190,150,90,.45);
      cursor: pointer;
    }
    .spot-photo:hover {
      opacity: 0.85;
    }

    .spot-note {
      margin-top: 8px;
      padding: 6px 8px 8px;
      border-radius: 12px;
      background: #fff7ec;
      border: 1px dashed var(--border-soft);
      font-size: 12px;
      color: var(--brown-soft);
    }
    .spot-note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .spot-note-title {
      font-weight: 600;
      font-size: 12px;
      color: var(--brown-main);
    }
    .spot-note-body {
      white-space: pre-wrap;
      min-height: 28px;
    }

    #btnUndo {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: #ffd694;
      font-weight: 600;
      padding-inline: 18px;
      z-index: 20;
    }

    @media (min-width: 768px) {
      main {
        max-width: 720px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Niji Trip 2026 ğŸŒˆ</h1>
    <p>æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œãƒ»æ‹–æ‹‰æ’åºï¼‹ä½å®¿æ¬„ä½ï¼‹æ¯æ—¥èŠ±è²»ï¼‹å›ä¸Šä¸€æ­¥ã€‚</p>
    <div class="hint">
      <span>âœï¸</span>
      <div>è¡Œç¨‹å¡å¯ä»¥ç›´æ¥æ”¹æ–‡å­—ã€æ‹–æ‹‰æ’åºï¼›éŒ¯èª¤å¯ä»¥ç”¨å³ä¸‹è§’ã€Œå›ä¸Šä¸€æ­¥ã€ã€‚</div>
    </div>
    <div class="top-btn-row">
      <button id="btnExport">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
      <button id="btnImport">åŒ¯å…¥å‚™ä»½</button>
      <button id="btnAddDay">ï¼‹ æ–°å¢ä¸€å¤©</button>
      <button id="btnRemoveDay" class="btn-secondary">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
    </div>
  </header>

  <!-- åŒ¯å…¥å‚™ä»½ç”¨ -->
  <input type="file" id="backupImport" accept="application/json" style="display:none">
  <!-- ç…§ç‰‡ä¸Šå‚³å…±ç”¨ input -->
  <input type="file" id="photoInput" accept="image/*" style="display:none">

  <div class="day-nav">
    <div class="day-nav-row">
      <a class="day-chip" href="#day-1" data-day-id="day-1" draggable="true">
        <span class="day-chip-main" contenteditable="true">Day 1</span>
        <span class="day-chip-sub" contenteditable="true">5/20</span>
      </a>
      <a class="day-chip" href="#day-2" data-day-id="day-2" draggable="true">
        <span class="day-chip-main" contenteditable="true">Day 2</span>
        <span class="day-chip-sub" contenteditable="true">5/21</span>
      </a>
    </div>
  </div>

  <main id="content">
    <!-- Day 1 -->
    <section id="day-1" data-date="5/20">
      <div class="day-title editable-block" contenteditable="true">Day 1ï¼ˆ5/20ï¼‰</div>

      <div class="expense-card editable-block" contenteditable="true">
        <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
        <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
      </div>

      <div class="quick-add">
        <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
        <div class="quick-add-row">
          <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰">
          <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€">
          <button class="qa-btn" type="button">æ–°å¢</button>
        </div>
      </div>

      <div class="spot-card" draggable="true">
        <div class="spot-text">
          <div class="name-zh" contenteditable="true">æˆç”°æ©Ÿå ´</div>
          <div class="name-ja" contenteditable="true">æˆç”°ç©ºæ¸¯</div>
          <div class="spot-meta" contenteditable="true">æˆç”°ãƒ»ä¸Šé‡ãƒ»æŠµé”æ—¥æœ¬</div>
        </div>
        <div class="btn-row">
          <button class="btn btn-dir" type="button">å¾é£¯åº—å°èˆª</button>
          <button class="btn btn-map" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
          <button class="btn btn-photo" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
          <button class="btn btn-drag btn-secondary" type="button">â‹®â‹® æ‹–æ‹‰èª¿æ•´é †åº</button>
        </div>
        <div class="image-list"></div>
        <div class="spot-note">
          <div class="spot-note-header">
            <span class="spot-note-title">å‚™è¨»</span>
            <button class="btn btn-note-photo" type="button">ğŸ“·</button>
          </div>
          <div class="spot-note-body" contenteditable="true">
å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰â€¦</div>
          <div class="note-image-list"></div>
        </div>
      </div>
    </section>

    <!-- Day 2 -->
    <section id="day-2" data-date="5/21">
      <div class="day-title editable-block" contenteditable="true">Day 2ï¼ˆ5/21ï¼‰</div>

      <div class="expense-card editable-block" contenteditable="true">
        <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
        <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
      </div>

      <div class="quick-add">
        <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
        <div class="quick-add-row">
          <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰">
          <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€">
          <button class="qa-btn" type="button">æ–°å¢</button>
        </div>
      </div>
    </section>
  </main>

  <button id="btnUndo">â†© å›ä¸Šä¸€æ­¥</button>

  <script>
  (function () {
    const STORAGE_KEY = "nijiTrip2026_v15";
    const UNDO_LIMIT = 25;

    let undoStack = [];
    let isRestoring = false;
    let saveTimer = null;
    let currentPhotoCard = null;
    let photoTargetType = "card"; // "card" | "note"

    // ========== å„²å­˜ / é‚„åŸ ==========
    function getState() {
      const nav = document.querySelector(".day-nav-row");
      const content = document.getElementById("content");
      return {
        nav: nav ? nav.innerHTML : "",
        content: content ? content.innerHTML : ""
      };
    }

    function setState(state) {
      const nav = document.querySelector(".day-nav-row");
      const content = document.getElementById("content");
      if (!nav || !content) return;
      isRestoring = true;
      nav.innerHTML = state.nav || "";
      content.innerHTML = state.content || "";
      isRestoring = false;
      afterDomRebuild();
    }

    function saveState(pushUndo = true) {
      if (isRestoring) return;
      const state = getState();
      if (pushUndo) {
        undoStack.push(state);
        if (undoStack.length > UNDO_LIMIT) undoStack.shift();
        updateUndoBtn();
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function scheduleSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveState(true), 350);
    }

    function restoreFromLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // åˆæ¬¡ä½¿ç”¨ï¼šæŠŠç›®å‰ DOM å­˜æˆåˆå§‹ç‹€æ…‹
        saveState(false);
        undoStack = [getState()];
        updateUndoBtn();
        return;
      }
      try {
        const state = JSON.parse(raw);
        setState(state);
        undoStack = [state];
        updateUndoBtn();
      } catch (e) {
        console.error("restore error", e);
      }
    }

    function updateUndoBtn() {
      const btn = document.getElementById("btnUndo");
      if (!btn) return;
      btn.disabled = undoStack.length <= 1;
      btn.style.opacity = btn.disabled ? 0.5 : 1;
    }

    function undo() {
      if (undoStack.length <= 1) return;
      undoStack.pop();               // ç§»é™¤ç¾åœ¨é€™ä¸€æ­¥
      const prev = undoStack[undoStack.length - 1];
      setState(prev);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(prev));
      updateUndoBtn();
    }

    // ========== æ—¥æœŸè™•ç† ==========
    function parseDate(str) {
      const m = /(\d+)\s*\/\s*(\d+)/.exec(str || "");
      if (!m) return null;
      return new Date(2026, +m[1] - 1, +m[2]);
    }
    function formatDate(d) {
      return `${d.getMonth() + 1}/${d.getDate()}`;
    }
    function addOneDayStr(str) {
      const d = parseDate(str);
      if (!d) return "";
      d.setDate(d.getDate() + 1);
      return formatDate(d);
    }

    // ä¾ Day chip é‡æ–°æ•´ç† dayN èˆ‡ section id / title / data-date
    function renumberDays() {
      const nav = document.querySelector(".day-nav-row");
      const content = document.getElementById("content");
      if (!nav || !content) return;

      const chips = [...nav.querySelectorAll(".day-chip")];
      const secs = [...content.querySelectorAll("section[id^='day-']")];

      chips.forEach((chip, i) => {
        const sec = secs[i];
        if (!sec) return;
        const dayNum = i + 1;
        const sub = chip.querySelector(".day-chip-sub");
        const main = chip.querySelector(".day-chip-main");
        const dateText = sub ? sub.textContent.trim() : "";

        chip.href = `#day-${dayNum}`;
        chip.dataset.dayId = `day-${dayNum}`;

        if (sec.id !== `day-${dayNum}`) sec.id = `day-${dayNum}`;
        if (dateText) sec.setAttribute("data-date", dateText);

        if (main) main.textContent = `Day ${dayNum}`;
        const title = sec.querySelector(".day-title");
        if (title) title.textContent = `Day ${dayNum}ï¼ˆ${dateText}ï¼‰`;
      });
    }

    // å¾ Day 1 çš„æ—¥æœŸé–‹å§‹ï¼Œå¾Œé¢è‡ªå‹• +1 å¤©
    function autoFixDates() {
      const nav = document.querySelector(".day-nav-row");
      if (!nav) return;
      const chips = [...nav.querySelectorAll(".day-chip")];
      if (!chips.length) return;

      let curDate = chips[0].querySelector(".day-chip-sub")?.textContent.trim();
      for (let i = 1; i < chips.length; i++) {
        const next = addOneDayStr(curDate);
        const sub = chips[i].querySelector(".day-chip-sub");
        if (sub && next) sub.textContent = next;
        curDate = next;
      }
      renumberDays();
      saveState(true);
    }

    // ========== æ–°å¢ / åˆªé™¤ å¤© ==========
    function addDay() {
      const nav = document.querySelector(".day-nav-row");
      const content = document.getElementById("content");
      if (!nav || !content) return;

      const chips = [...nav.querySelectorAll(".day-chip")];
      const secs = [...content.querySelectorAll("section[id^='day-']")];
      const lastChip = chips[chips.length - 1];
      const lastDate = lastChip?.querySelector(".day-chip-sub")?.textContent.trim() || "";
      const newDate = addOneDayStr(lastDate) || lastDate || "5/20";
      const newNum = chips.length + 1;

      // Day chip
      const chip = document.createElement("a");
      chip.className = "day-chip";
      chip.dataset.dayId = `day-${newNum}`;
      chip.href = `#day-${newNum}`;
      chip.setAttribute("draggable", "true");
      chip.innerHTML = `
        <span class="day-chip-main" contenteditable="true">Day ${newNum}</span>
        <span class="day-chip-sub" contenteditable="true">${newDate}</span>
      `;
      nav.appendChild(chip);

      // å°æ‡‰ section
      const sec = document.createElement("section");
      sec.id = `day-${newNum}`;
      sec.setAttribute("data-date", newDate);
      sec.innerHTML = `
        <div class="day-title editable-block" contenteditable="true">Day ${newNum}ï¼ˆ${newDate}ï¼‰</div>
        <div class="expense-card editable-block" contenteditable="true">
          <div class="expense-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
          <div>ä»Šå¤©çš„è¡Œç¨‹å…§å®¹è«‹åœ¨ä¸‹æ–¹æ–°å¢è¡Œç¨‹å¡ç‰‡ï¼Œæˆ–è²¼ä¸ŠèˆŠæª”å…§å®¹ã€‚</div>
        </div>
        <div class="quick-add">
          <div class="quick-add-title">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</div>
          <div class="quick-add-row">
            <input type="text" class="qa-name" placeholder="åœ°é»åç¨±ï¼ˆä¸­æ–‡ï¼‰">
            <input type="text" class="qa-jp" placeholder="æ—¥æ–‡åç¨±æˆ–åœ°å€">
            <button class="qa-btn" type="button">æ–°å¢</button>
          </div>
        </div>
      `;
      content.appendChild(sec);

      attachDayDrag();
      attachCardEvents();
      renumberDays();
      autoFixDates();
    }

    function removeDay() {
      const nav = document.querySelector(".day-nav-row");
      const content = document.getElementById("content");
      if (!nav || !content) return;

      const chips = [...nav.querySelectorAll(".day-chip")];
      const secs = [...content.querySelectorAll("section[id^='day-']")];
      if (chips.length <= 1) {
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©å”·ï¼");
        return;
      }
      chips[chips.length - 1].remove();
      secs[secs.length - 1].remove();

      renumberDays();
      saveState(true);
    }

    // ========== æ‹–æ‹‰ Day chip ==========
    function attachDayDrag() {
      const nav = document.querySelector(".day-nav-row");
      if (!nav) return;

      [...nav.querySelectorAll(".day-chip")].forEach(chip => {
        chip.setAttribute("draggable", "true");
      });

      let dragging = null;

      nav.onDragStartListener && nav.removeEventListener("dragstart", nav.onDragStartListener);
      nav.onDragOverListener && nav.removeEventListener("dragover", nav.onDragOverListener);
      nav.onDragEndListener && nav.removeEventListener("dragend", nav.onDragEndListener);

      nav.onDragStartListener = e => {
        const chip = e.target.closest(".day-chip");
        if (!chip) return;
        dragging = chip;
        chip.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      };
      nav.onDragOverListener = e => {
        e.preventDefault();
        const target = e.target.closest(".day-chip");
        if (!dragging || !target || dragging === target) return;
        const rect = target.getBoundingClientRect();
        const before = e.clientX < rect.left + rect.width / 2;
        if (before) nav.insertBefore(dragging, target);
        else nav.insertBefore(dragging, target.nextSibling);
      };
      nav.onDragEndListener = () => {
        if (dragging) dragging.classList.remove("dragging");
        dragging = null;
        renumberDays();
        autoFixDates();
      };

      nav.addEventListener("dragstart", nav.onDragStartListener);
      nav.addEventListener("dragover", nav.onDragOverListener);
      nav.addEventListener("dragend", nav.onDragEndListener);
    }

    function watchDateEdit() {
      const nav = document.querySelector(".day-nav-row");
      if (!nav) return;
      nav.addEventListener("input", e => {
        if (e.target.classList.contains("day-chip-sub")) {
          autoFixDates();
        } else if (e.target.classList.contains("day-chip-main")) {
          renumberDays();
          saveState(true);
        }
      });
    }

    // ========== è¡Œç¨‹å¡ç‰‡ç›¸é—œ ==========
    function createSpotCard(zh, jp) {
      const card = document.createElement("div");
      card.className = "spot-card";
      card.setAttribute("draggable", "true");
      card.innerHTML = `
        <div class="spot-text">
          <div class="name-zh" contenteditable="true">${zh || "æ–°æ™¯é»"}</div>
          <div class="name-ja" contenteditable="true">${jp || ""}</div>
          <div class="spot-meta" contenteditable="true">å¯è¼¸å…¥åœ°å€ãƒ»è»Šç«™ãƒ»å…¶ä»–èªªæ˜</div>
        </div>
        <div class="btn-row">
          <button class="btn btn-dir" type="button">å¾é£¯åº—å°èˆª</button>
          <button class="btn btn-map" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
          <button class="btn btn-photo" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
          <button class="btn btn-drag btn-secondary" type="button">â‹®â‹® æ‹–æ‹‰èª¿æ•´é †åº</button>
        </div>
        <div class="image-list"></div>
        <div class="spot-note">
          <div class="spot-note-header">
            <span class="spot-note-title">å‚™è¨»</span>
            <button class="btn btn-note-photo" type="button">ğŸ“·</button>
          </div>
          <div class="spot-note-body" contenteditable="true">å¯åœ¨é€™è£¡å¯«é€™å€‹æ™¯é»çš„å°æé†’ã€é¤é»ã€æ’éšŠæ™‚é–“ç­‰â€¦</div>
          <div class="note-image-list"></div>
        </div>
      `;
      return card;
    }

    function attachCardEvents() {
      const content = document.getElementById("content");
      if (!content) return;

      // å¿«é€Ÿæ–°å¢è¡Œç¨‹å¡ç‰‡
      content.querySelectorAll(".quick-add .qa-btn").forEach(btn => {
        btn.onclick = () => {
          const qa = btn.closest(".quick-add");
          const sec = btn.closest("section[id^='day-']");
          if (!qa || !sec) return;
          const nameInput = qa.querySelector(".qa-name");
          const jpInput = qa.querySelector(".qa-jp");
          const zh = nameInput.value.trim() || "æ–°æ™¯é»";
          const jp = jpInput.value.trim();
          const card = createSpotCard(zh, jp);
          sec.appendChild(card);
          nameInput.value = "";
          jpInput.value = "";
          attachCardDrag();
          attachPhotoButtons();
          scheduleSave();
        };
      });

      attachCardDrag();
      attachPhotoButtons();
      attachMapButtons();
    }

    // æ‹–æ‹‰è¡Œç¨‹å¡ç‰‡
    function attachCardDrag() {
      const content = document.getElementById("content");
      if (!content) return;
      content.querySelectorAll(".spot-card").forEach(card => {
        card.setAttribute("draggable", "true");
      });

      let draggingCard = null;

      content.onCardDragStart && content.removeEventListener("dragstart", content.onCardDragStart);
      content.onCardDragOver && content.removeEventListener("dragover", content.onCardDragOver);
      content.onCardDragEnd && content.removeEventListener("dragend", content.onCardDragEnd);

      content.onCardDragStart = e => {
        const card = e.target.closest(".spot-card");
        if (!card) return;
        draggingCard = card;
        card.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      };
      content.onCardDragOver = e => {
        const card = e.target.closest(".spot-card");
        if (!draggingCard || !card || draggingCard === card) return;
        e.preventDefault();
        const rect = card.getBoundingClientRect();
        const before = e.clientY < rect.top + rect.height / 2;
        const parent = card.parentElement;
        if (before) parent.insertBefore(draggingCard, card);
        else parent.insertBefore(draggingCard, card.nextSibling);
      };
      content.onCardDragEnd = () => {
        if (draggingCard) draggingCard.classList.remove("dragging");
        draggingCard = null;
        scheduleSave();
      };

      content.addEventListener("dragstart", content.onCardDragStart);
      content.addEventListener("dragover", content.onCardDragOver);
      content.addEventListener("dragend", content.onCardDragEnd);
    }

    // åœ°åœ–æŒ‰éˆ•
    function attachMapButtons() {
      const content = document.getElementById("content");
      if (!content) return;

      content.querySelectorAll(".btn-map").forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest(".spot-card");
          if (!card) return;
          const zh = card.querySelector(".name-zh")?.textContent.trim() || "";
          const jp = card.querySelector(".name-ja")?.textContent.trim() || "";
          const q = encodeURIComponent((jp || zh) || "æ™¯é»");
          const url = "https://www.google.com/maps/search/?api=1&query=" + q;
          window.open(url, "_blank");
        };
      });

      content.querySelectorAll(".btn-dir").forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest(".spot-card");
          if (!card) return;
          const zh = card.querySelector(".name-zh")?.textContent.trim() || "";
          const jp = card.querySelector(".name-ja")?.textContent.trim() || "";
          const q = encodeURIComponent("é£¯åº— åˆ° " + (jp || zh || "æ™¯é»"));
          const url = "https://www.google.com/maps/search/?api=1&query=" + q;
          window.open(url, "_blank");
        };
      });
    }

    // ç…§ç‰‡æŒ‰éˆ•
    function attachPhotoButtons() {
      const content = document.getElementById("content");
      const photoInput = document.getElementById("photoInput");
      if (!content || !photoInput) return;

      content.querySelectorAll(".btn-photo").forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest(".spot-card");
          if (!card) return;
          currentPhotoCard = card;
          photoTargetType = "card";
          photoInput.value = "";
          photoInput.click();
        };
      });

      content.querySelectorAll(".btn-note-photo").forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest(".spot-card");
          if (!card) return;
          currentPhotoCard = card;
          photoTargetType = "note";
          photoInput.value = "";
          photoInput.click();
        };
      });

      photoInput.onchange = () => {
        const file = photoInput.files && photoInput.files[0];
        if (!file || !currentPhotoCard) return;
        const reader = new FileReader();
        reader.onload = e => {
          const url = e.target.result;
          const list = photoTargetType === "note"
            ? currentPhotoCard.querySelector(".note-image-list")
            : currentPhotoCard.querySelector(".image-list");
          if (!list) return;
          const img = document.createElement("img");
          img.className = "spot-photo";
          img.src = url;
          img.alt = "è¡Œç¨‹ç…§ç‰‡";
          list.appendChild(img);

          img.addEventListener("click", () => {
            if (confirm("åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ")) {
              img.remove();
              scheduleSave();
            }
          });

          scheduleSave();
        };
        reader.readAsDataURL(file);
      };
    }

    // ========== åŒ¯å‡º / åŒ¯å…¥ ==========
    function attachBackupButtons() {
      const exportBtn = document.getElementById("btnExport");
      const importBtn = document.getElementById("btnImport");
      const fileInput = document.getElementById("backupImport");

      if (exportBtn) {
        exportBtn.onclick = () => {
          const data = {
            savedAt: new Date().toISOString(),
            state: getState()
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "NijiTrip2026_backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        };
      }

      if (importBtn && fileInput) {
        importBtn.onclick = () => {
          fileInput.value = "";
          fileInput.click();
        };
        fileInput.onchange = () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = e => {
            try {
              const obj = JSON.parse(e.target.result);
              const state = obj.state || obj;
              setState(state);
              undoStack = [state];
              localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
              updateUndoBtn();
              alert("åŒ¯å…¥å®Œæˆï¼");
            } catch (err) {
              console.error(err);
              alert("åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚");
            }
          };
          reader.readAsText(file, "utf-8");
        };
      }
    }

    // ========== DOM é‡å»ºå¾Œé‡æ–°æ›äº‹ä»¶ ==========
    function afterDomRebuild() {
      // ç·¨è¼¯å…§å®¹ â†’ è‡ªå‹•å­˜æª”
      const content = document.getElementById("content");
      if (content) {
        content.oninput = () => scheduleSave();
      }
      attachDayDrag();
      watchDateEdit();
      attachCardEvents();
      attachBackupButtons();
      renumberDays();
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener("DOMContentLoaded", () => {
      restoreFromLocal();
      afterDomRebuild();

      document.getElementById("btnAddDay").onclick = addDay;
      document.getElementById("btnRemoveDay").onclick = removeDay;
      document.getElementById("btnUndo").onclick = undo;

      // åˆæ¬¡è¼‰å…¥æ™‚ä¹Ÿä¿®æ­£ä¸€æ¬¡æ—¥æœŸ
      autoFixDates();
    });
  })();
  </script>
</body>
</html>
